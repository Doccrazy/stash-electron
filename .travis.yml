matrix:
  include:
    - os: osx
      osx_image: xcode10.2
      language: node_js
      node_js: "12"
      env:
        - ELECTRON_CACHE=$HOME/.cache/electron
        - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder

    - os: linux
      services: docker
      language: generic

git:
  depth: false

cache:
  directories:
    - $HOME/.cache/electron
    - $HOME/.cache/electron-builder

env:
  global:
    - ELECTRON_CACHE=$HOME/.cache/electron
    - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder
    - secure: Li9Cdqy5wz/lws1eiTFusPNRdFJbGXsVDq4kFCyJSepeRV2TfpOSiwOlbjvHwrZvWcM4OFZ+HJDxlS8Sph6ZkJ/K1VZgCaqUbRFegh0LsByHO7VC6UiWYtRmzq+iQytc0ykLRMUneqId/Ll/BTMY4YWGYnjUBkuogzVLduJZCG5603mMh7/6cd6Fxjjdd/bUSEYFphLw2nnFLF0vZQ6+M43k6M2AAB2Arx5e1CWWcUPvfVUIGTyA2f8R0ZltwsD4K0+gPhqP/nmbCKo2gbqEsp3O7GEBAOz7/D/3D6o/tcBvcEFZ0xB2Yk65l15paK2EIZ+V2aY3eYdApbZ5PQkNKNT5PhsoBtvH1XNZIPq1qvtiNhlY5LY+du7n6u496KYaAaSNnEd2gjQjjTYg4ggYKvNc9T81e+Q8LSXXNR2P3SrC7Rp9LsGW+daO+m+atAYzhb+odcq4EsLcCgGeHOwPNjojJqw3rP9HzsHPDXuq61CFbZGcJgeeCsV+ZqjA1JVvMB0/rUJpGv/iRd7FBgkotVJLU+nnZ75ZV3qxBe83KvT0ERmdRpwQmBca8s4An6qJFN6vUN1vmcMLosR6NIniiDDr0s0D+hmTl4ww1eN4vPLcjrNRDcgZHUip1b/CkgW2PG1x9mB6yb9pYVsEgXzzzqRJ0mLuvNsYkaniAkzEPiQ=

before_install:
  - |
    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      /sbin/start-stop-daemon --start --quiet --pidfile /tmp/custom_xvfb_99.pid --make-pidfile --background --exec /usr/bin/Xvfb -- :99 -ac -screen 0 1280x1024x16
      openssl aes-256-cbc -K $encrypted_525ecc25ac52_key -iv $encrypted_525ecc25ac52_iv -in dist/deploy_key.enc -out /tmp/deploy_key -d
      chmod 600 /tmp/deploy_key
    fi

before_script:
  - |
    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      export DISPLAY=:99.0
      sh -e /etc/init.d/xvfb start &
      sleep 3
    fi
  - |
    if [ "$TRAVIS_REPO_SLUG" == "Doccrazy/stash-electron" ] && [ "$TRAVIS_BRANCH" == "master" ] && [ "$TRAVIS_PULL_REQUEST" == "false" ]; then
      export DEPLOY_RELEASE=true
    elif [ "$TRAVIS_REPO_SLUG" == "Doccrazy/stash-electron" ] && [ -n "$TRAVIS_TAG" ]; then
      export DEPLOY_RELEASE=true
    fi

script:
  - |
    if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      docker run --rm \
        $(env | \
          grep -Eo '^[^\s=]*(DEBUG|NODE_|ELECTRON_|YARN_|NPM_|CI|CIRCLE|TRAVIS|APPVEYOR_|CSC_|_TOKEN|_KEY|AWS_|STRIP|BUILD_|DISPLAY|DEPLOY)[^\s=]*' | \
          sed '/^$/d;s/^/-e /' | \
          paste -sd ' ' \
        ) \
        -v ${PWD}:/project \
        -v ~/.cache/electron:/root/.cache/electron \
        -v ~/.cache/electron-builder:/root/.cache/electron-builder \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        electronuserland/builder:wine-mono-11.19 \
        /bin/bash -c 'yarn install && yarn lint && yarn test && DISPLAY= yarn run package linux win'
    else
      yarn run package mac
    fi

after_success:
  - |
    if [ "$TRAVIS_OS_NAME" == "linux" ] && [ -n "$DEPLOY_RELEASE" ] && [ -z "$DEB_SKIP_PUBLISH" ]; then
      sudo apt-get update
      sudo apt-get -y install zstd
      bash dist/arch/update-aur.sh
      bash dist/bintray-cleanup.sh
    fi

before_cache:
  - rm -rf $HOME/.cache/electron-builder/wine
